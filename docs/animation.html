<!DOCTYPE html>
<html ondrop='dropHandler(event)' ondragover='dragOverHandler(event)'>
<head>
<title>Spelunky 2 Animation Thing</title>
<style>
body {
	background: #222;
	font-family: Segoe UI, sans-serif;
	color: #eee;
	display: flex;
	flex-basis: flex-start;
	align-items: center;
}
h1,h2 {
	text-align: center;
}
#container {
	margin: 0 auto;
	position: relative;
}

#source {
	margin: 0 auto;
	width: 1024px;
	aspect-ratio: 1 / 1;
	border: 1px solid rgba(255,255,255,0.5);
	background-size: 100% 100%;
}
#overlay {
	position: absolute;
	width: 1024px;
	aspect-ratio: 1 / 1;
	border: 1px solid rgba(255,255,255,0.5);
	background-size: 100% 100%;
}
#list {
	display: inline-block;
	height: 1024px;
	overflow: scroll;
	font-size: 13px;
	max-height: 1024px;
}
ul {
	padding-left: 10px;
}
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.2/FileSaver.min.js"></script>
</head>
<body>
<div id='container'>
<h1>Spelunky 2 Animation Thing</h1>
<h2>Just drop any vanilla texture png here to show all animations in it!</h2>
<div id='flex'>
<canvas id='overlay'></canvas>
<canvas id='source'></canvas>
<div id='list'></div>
</div>
</div>
<script>
var textures = {}
var entities = {}
var filename = ''
var used_textures = []
var colors = ['red', 'green', 'skyblue', 'cyan', 'magenta', 'yellow', 'orange', 'hotpink', 'brown', 'maroon', 'lime', 'olive']
var color = 0
var overlap = []
var max_overlap = []
var start_overlap = []

var loadJsonFiles = () => {
	fetch('textures.json')
  		.then(response => response.json())
  		.then(json => textures = json)
  	fetch('entities.json')
  		.then(response => response.json())
  		.then(json => entities = json)
}

var getTexture = () => {
	used_textures = []
	for ([k, tex] of Object.entries(textures)) {
		if (tex.path.match("/"+filename)) {
			used_textures[k] = tex
		}
	}
}

var setTextureSize = function(w, h) {
	document.getElementById('source').width = w
	document.getElementById('source').height = h
	document.getElementById('source').style.aspectRatio = w+' / '+h
	document.getElementById('overlay').width = w
	document.getElementById('overlay').height = h
	document.getElementById('overlay').style.aspectRatio = w+' / '+h
	document.getElementById('list').style.height = h
	drawGrid('overlay', w, h)
}

var getGridW = function(tex) {
	return textures[tex].tile_width
}

var getGridH = function(tex) {
	return textures[tex].tile_height
}

var getTextureW = function(tex) {
	return textures[tex].width
}

var getTextureH = function(tex) {
	return textures[tex].height
}

var drawRect = function(ctx, key, frame, count, tex) {
	var x = textures[tex].offset.width + getGridW(tex) * (frame % textures[tex].num_tiles.width)
	var y = textures[tex].offset.height + getGridH(tex) * Math.floor(frame / textures[tex].num_tiles.width)
	var w = getGridW(tex) * count
	var h = getGridH(tex)

	if (!overlap[tex])
		overlap[tex] = []
	if (!max_overlap[tex])
		max_overlap[tex] = []
	if (!start_overlap[tex])
		start_overlap[tex] = []
	var m = overlap[tex][frame] && (4 + overlap[tex][frame] * 4) || 4
	var kx = (start_overlap[tex][frame] ? start_overlap[tex][frame] * 26 + 6 : 6)
	var ky = max_overlap[tex][frame] && max_overlap[tex][frame] * 4 || 0

   	color = (color + 1) % colors.length
	ctx.globalAlpha = 1
	ctx.fillStyle = colors[color]
	ctx.font = "20px monospace";
	ctx.fontWeight = 400;
	ctx.fillText(1+1*key, x + kx + 6, y + ky + 20)

	ctx.globalAlpha = 0.88
	ctx.lineWidth = 3
	ctx.strokeStyle = colors[color]
	ctx.beginPath()

	ctx.rect(x + m, y + m, w - m*2, h - m*2)
	var overflow = w
	while (overflow > getTextureW(tex)) {
		overflow -= getTextureW(tex)
		x = 0
		y += getGridH(tex)
		ctx.rect(x-100, y + m, overflow - m + 100, h - m*2)
	}
	ctx.stroke()
	for (var i = 0; i < count; i++)
    	overlap[tex][frame+i] = overlap[tex][frame+i] && ++overlap[tex][frame+i] || 1
    start_overlap[tex][frame] = start_overlap[tex][frame] && ++start_overlap[tex][frame] || 1
   	return colors[color]
}

var drawGrid = function(id, w, h) {
	var grid = document.createElement('canvas')
	var ctx = grid.getContext('2d')
	grid.width = w
	grid.height = h
	ctx.lineWidth = 2

	/*for (x=0;x<=w;x+=getGridW()) {
		for (y=0;y<=h;y+=getGridH()) {
			ctx.moveTo(x, 0)
			ctx.lineTo(x, h)
			ctx.stroke()
			ctx.moveTo(0, y)
			ctx.lineTo(w, y)
			ctx.stroke()
		}
	}*/

	overlap = []
	max_overlap = []
	start_overlap = []
	document.getElementById('list').innerHTML = ''

	for ([_, ent] of Object.entries(entities)) {
		if (!used_textures[ent.texture])
			continue
		max_overlap[ent.texture] = []
		for ([_, anim] of Object.entries(ent.animations)) {
			for (var i = 0; i < anim.count; i++)
				max_overlap[ent.texture][anim.texture+i] = max_overlap[ent.texture][anim.texture+i] && ++max_overlap[ent.texture][anim.texture+i] || 1
		}
	}
	var out = '<ul>'
	for ([type, ent] of Object.entries(entities)) {
		if (!used_textures[ent.texture])
			continue
		if (Object.keys(ent.animations).length == 0)
			continue

		out += '<li>' + type + '<ul>'
		for ([_, anim] of Object.entries(ent.animations)) {
			var color = drawRect(ctx, anim.key, anim.texture, anim.count, ent.texture)
			out += '<li style="color: ' + color + '"><strong>' + (1*anim.key + 1) + '</strong>, ' + anim.texture + (anim.count > 1 ? ' - ' + (anim.texture+anim.count-1) : '') + '</li>'
		}
		out += '</ul></li>'
	}
	out += '</ul>'
	document.getElementById('list').innerHTML = out
	document.getElementById(id).style.backgroundImage = 'url('+grid.toDataURL()+')'
}

var dropHandler = (e) => {
	e.preventDefault()
	if (e.dataTransfer.items) {
		for (var i = 0; i < e.dataTransfer.items.length; i++) {
			if (e.dataTransfer.items[i].kind === 'file') {
				var file = e.dataTransfer.items[i].getAsFile()
				filename = file.name.replace('.png', '.DDS')
				getTexture()
				var reader = new FileReader()
				var image = new Image()
				reader.onload = (() => {
					return (f) => {
						var image = new Image()
						image.src = f.target.result
						image.onload = () => {
							var canvas = document.getElementById('source')
							setTextureSize(image.width, image.height)
							var ctx = canvas.getContext('2d')
							ctx.clearRect(0, 0, canvas.width, canvas.height);
							ctx.drawImage(image, 0, 0, image.width, image.height, 0, 0, canvas.width, canvas.height)
						}
					}
				})(e.target)
				reader.readAsDataURL(file)
			}
		}
	}
}
var dragOverHandler = (e) => {
	e.preventDefault()
}
loadJsonFiles()
</script>
</body>
</html>
